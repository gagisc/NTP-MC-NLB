name: Infrastructure Quality Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  shell-linting:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Lint Shell Scripts
        run: |
          find scripts/ -name "*.sh" -type f | while read script; do
            echo "Checking: $script"
            shellcheck "$script" || true
          done
        continue-on-error: true

  ansible-linting:
    name: Ansible Playbook Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ansible-lint
        run: pip install ansible-lint ansible
      
      - name: Lint Ansible Playbooks
        run: |
          ansible-lint ansible/ -v || true
        continue-on-error: true

  json-validation:
    name: JSON Configuration Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON Files
        run: |
          find . -name "*.json" -type f | while read file; do
            echo "Validating: $file"
            python3 -m json.tool "$file" > /dev/null && echo "âœ… Valid" || echo "âŒ Invalid"
          done
        continue-on-error: true

  documentation-check:
    name: Documentation Completeness
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Documentation Files
        run: |
          echo "## ðŸ“š Documentation Status" > doc-report.md
          echo "" >> doc-report.md
          
          required_docs=("README.md" "docs/ARCHITECTURE.md" "docs/DEPLOYMENT_GUIDE.md" "docs/QUICK_START.md")
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              lines=$(wc -l < "$doc")
              echo "âœ… **$doc** ($lines lines)" >> doc-report.md
            else
              echo "âŒ **$doc** (MISSING)" >> doc-report.md
            fi
          done
          
          echo "" >> doc-report.md
          echo "### Project Structure" >> doc-report.md
          echo "" >> doc-report.md
          
          find . -maxdepth 1 -type d ! -name '.*' ! -name 'node_modules' | sort | while read dir; do
            count=$(find "$dir" -type f | wc -l)
            echo "- **$dir**: $count files" >> doc-report.md
          done
          
          cat doc-report.md
      
      - name: Comment PR with Documentation Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('doc-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [shell-linting, ansible-linting, json-validation, documentation-check]
    if: always()
    steps:
      - name: Generate Quality Report
        run: |
          echo "## âœ… Infrastructure Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Shell scripts validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ansible playbooks validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JSON configurations validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation complete" >> $GITHUB_STEP_SUMMARY
